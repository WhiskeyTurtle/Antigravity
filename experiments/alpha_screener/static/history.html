<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ANTIGRAVITY // TRADE HISTORY</title>
    <style>
        :root {
            --bg: #050505;
            --panel: #111;
            --accent: #00ff9d;
            --danger: #ff0055;
            --text: #eee;
            --dim: #555;
            --font: 'Courier New', monospace;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: var(--font);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        header {
            border-bottom: 2px solid var(--accent);
            padding-bottom: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            margin: 0;
            letter-spacing: 2px;
            text-transform: uppercase;
            font-size: 1.5rem;
        }

        a {
            color: var(--accent);
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        #history-panel {
            flex: 1;
            background: var(--panel);
            border: 1px solid var(--dim);
            padding: 15px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
        }

        th {
            text-align: left;
            padding: 10px;
            border-bottom: 1px solid var(--accent);
            color: var(--accent);
            font-weight: normal;
            position: sticky;
            top: 0;
            background: var(--panel);
        }

        td {
            padding: 10px;
            border-bottom: 1px solid #222;
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .pnl-positive {
            color: var(--accent);
        }

        .pnl-negative {
            color: var(--danger);
        }

        .badge {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            text-transform: uppercase;
            background: #333;
            color: #ccc;
        }

        .type-paper {
            background: #184f34;
            color: #b9ffd9;
        }

        .type-live {
            background: #1a2e63;
            color: #b7d1ff;
        }
    </style>
</head>

<body>
    <header>
        <h1>Antigravity // Trade History</h1>
        <div style="font-size:1.2rem;">
            <a href="/">‚Üê BACK TO DASHBOARD</a>
        </div>
    </header>

    <div id="history-panel">
        <table id="history-table">
            <thead>
                <tr>
                    <th>TYPE</th>
                    <th>TOKEN</th>
                    <th>STRATEGY</th>
                    <th>RESULT</th>
                    <th>PNL (SOL)</th>
                    <th>PNL %</th>
                    <th>ENTRY SOL</th>
                    <th>ENTRY TIME</th>
                    <th>ENTRY PRICE</th>
                    <th>EXIT PRICE</th>
                    <th>DURATION</th>
                    <th>REASON</th>
                </tr>
            </thead>
            <tbody id="history-body">
                <tr>
                    <td colspan="12" style="text-align:center; padding:20px;">Loading history...</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div id="stats-footer"
        style="margin-top:20px; border-top:1px solid var(--dim); padding-top:10px; display:flex; gap:20px; font-size:0.9rem;">
        <div>Total Trades: <span id="total-trades" style="color:#fff">0</span></div>
        <div>Paper: <span id="paper-trades" style="color:#b9ffd9">0</span></div>
        <div>Live: <span id="live-trades" style="color:#b7d1ff">0</span></div>
        <div>Win Rate: <span id="win-rate" style="color:var(--accent)">0%</span></div>
        <div>Total PnL: <span id="total-pnl" style="color:#fff">0.00 SOL</span></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', loadHistory);

        async function loadHistory() {
            try {
                const res = await fetch('/api/history');
                const history = await res.json();
                renderTable(history);
            } catch (e) {
                document.getElementById('history-body').innerHTML = '<tr><td colspan="12" style="color:var(--danger); text-align:center;">Failed to load history</td></tr>';
                console.error(e);
            }
        }

        function formatStrategyMode(modeRaw) {
            const mode = String(modeRaw || '').trim().toLowerCase();
            if (mode === 'kol_momentum_scalper') return 'KOL Momentum';
            if (mode === 'early_20_scalper') return 'Early 20';
            if (mode === 'kol_launch_burst_scalper') return 'Launch Burst';
            if (!mode) return 'Unknown';
            return mode.replaceAll('_', ' ');
        }

        function normalizeEpochSeconds(rawValue) {
            if (rawValue === undefined || rawValue === null || rawValue === '') return 0;
            const asNumber = Number(rawValue);
            if (Number.isFinite(asNumber) && asNumber > 0) {
                return asNumber > 1e12 ? asNumber / 1000 : asNumber;
            }
            if (typeof rawValue === 'string') {
                const parsedMs = Date.parse(rawValue);
                if (Number.isFinite(parsedMs) && parsedMs > 0) return parsedMs / 1000;
            }
            return 0;
        }

        function formatDateTime(epochSecRaw) {
            const epochSec = normalizeEpochSeconds(epochSecRaw);
            if (!Number.isFinite(epochSec) || epochSec <= 0) return '--';
            return new Date(epochSec * 1000).toLocaleString();
        }

        function renderTable(trades) {
            const tbody = document.getElementById('history-body');
            tbody.innerHTML = '';

            if (!trades || trades.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" style="text-align:center; padding:20px; color:var(--dim);">No completed trades recorded.</td></tr>';
                return;
            }

            const sortedTrades = [...trades];

            let wins = 0;
            let totalPnL = 0;
            let paperCount = 0;
            let liveCount = 0;

            sortedTrades.forEach(trade => {
                const row = document.createElement('tr');
                const type = String(trade.trade_type || 'PAPER').toUpperCase();
                if (type === 'LIVE') liveCount++;
                else paperCount++;

                const isWin = trade.pnl >= 0;
                if (isWin) wins++;
                totalPnL += trade.pnl;

                const pnlClass = isWin ? 'pnl-positive' : 'pnl-negative';
                const sign = isWin ? '+' : '';

                // Fallbacks for missing fields in old data
                const pnlPct = trade.pnl_pct !== undefined ? trade.pnl_pct : 0;
                const entrySol = trade.entry_sol_amount || 0;
                const durationSec = Number(trade.duration || 0);
                const durationMin = durationSec > 0 ? (durationSec / 60).toFixed(1) + 'm' : '--';
                const entryPrice = Number(trade.entry_price || 0);
                const exitPrice = Number(trade.exit_price || trade.sell_price || 0);
                const closeTimeSec = normalizeEpochSeconds(trade.close_time ?? trade.closed_at);
                const explicitEntryTimeSec = normalizeEpochSeconds(
                    trade.entry_time ?? trade.opened_at ?? trade.start_time ?? trade.timestamp
                );
                const entryTimeSec = explicitEntryTimeSec > 0
                    ? explicitEntryTimeSec
                    : (closeTimeSec > 0
                        ? (durationSec > 0 ? Math.max(0, closeTimeSec - durationSec) : closeTimeSec)
                        : 0);
                const entryTimeLabel = formatDateTime(entryTimeSec);
                const strategyLabel = formatStrategyMode(trade.strategy_mode);

                const axiomLink = trade.pair_address ?
                    `https://axiom.trade/meme/${trade.pair_address}?chain=sol` :
                    `https://axiom.trade/discover?q=${trade.token}`;

                row.innerHTML = `
                    <td><span class="badge ${type === 'LIVE' ? 'type-live' : 'type-paper'}">${type}</span></td>
                    <td>
                        <a href="${axiomLink}" target="_blank" title="${trade.token}">${trade.token.substring(0, 8)}...</a>
                    </td>
                    <td><span class="badge">${strategyLabel}</span></td>
                    <td class="${pnlClass}">${isWin ? 'WIN' : 'LOSS'}</td>
                    <td class="${pnlClass}">${sign}${trade.pnl.toFixed(4)}</td>
                    <td class="${pnlClass}">${sign}${pnlPct.toFixed(2)}%</td>
                    <td>${entrySol.toFixed(4)}</td>
                    <td>${entryTimeLabel}</td>
                    <td>${entryPrice > 0 ? entryPrice.toFixed(9) : '--'}</td> 
                    <td>${exitPrice > 0 ? exitPrice.toFixed(9) : '--'}</td>
                    <td>${durationMin}</td>
                    <td><span class="badge" style="background:${trade.reason === 'TAKE_PROFIT' ? '#004400' : '#440000'}">${trade.reason}</span></td>
                `;
                tbody.appendChild(row);
            });

            // Update Stats
            document.getElementById('total-trades').innerText = trades.length;
            document.getElementById('paper-trades').innerText = paperCount;
            document.getElementById('live-trades').innerText = liveCount;
            const winRate = trades.length > 0 ? (wins / trades.length * 100).toFixed(1) : 0;
            document.getElementById('win-rate').innerText = winRate + '%';

            const pnlEl = document.getElementById('total-pnl');
            pnlEl.innerText = (totalPnL >= 0 ? '+' : '') + totalPnL.toFixed(4) + ' SOL';
            pnlEl.style.color = totalPnL >= 0 ? 'var(--accent)' : 'var(--danger)';
        }
    </script>
</body>

</html>
